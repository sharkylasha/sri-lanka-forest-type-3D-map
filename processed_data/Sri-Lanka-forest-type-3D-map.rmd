---
title: "Sri-Lanka-forest-type-3D-map"
author: "Lashanthini Rajendram"
date: "09/01/2024"
output: html_document
---


```{r}
libs <- c(
  "giscoR", "terra", "elevatr","sf",
  "png", "rayshader", "magick"
  )

installed_libs <- libs %in% rownames(
  installed.packages()
)

if(any(installed_libs == F)){
  install.packages(
    libs[!installed_libs]
  )
}

invisible(lapply(
  libs, library,
  character.only = T
))


## 1. COUNTRY BOUNDARIES 
##----------------------------## ##https://lcviewer.vito.be/2019

country_sf <- giscoR::gisco_get_countries(
   country = "LK",
  resolution = "1"
)
 
## 2. FOREST TYPE RASTERS - 2019, CROP AND PROJECT THEM
##------------------------------------------------------##

urls <- c("https://s3-eu-west-1.amazonaws.com/vito.landcover.global/v3.0.1/2019/E060N20/E060N20_PROBAV_LC100_global_v3.0.1_2019-nrt_Forest-Type-layer_EPSG-4326.tif", "https://s3-eu-west-1.amazonaws.com/vito.landcover.global/v3.0.1/2019/E080N20/E080N20_PROBAV_LC100_global_v3.0.1_2019-nrt_Forest-Type-layer_EPSG-4326.tif")

for(url in urls){
  download.file(
    url = url,
    destfile = basename(url),
    mode = "wb"
  )
}

raster_files <- list.files(
  path = getwd(),
  pattern = "tif",
  full.names = T
)

crs <- "EPSG:4326"

for(raster in raster_files){
  rasters <- terra::rast(raster)
  
  country <- country_sf |>
    sf::st_transform(
      crs = terra::crs(
        rasters
      )
    )
  
  country_forest_type <- terra::crop(
    rasters,
    terra::vect(
      country
    ),
    snap ="in",
    mask = T
  ) |>
    terra::aggregate(
      fact = 5,
      fun = "modal"
    )|>
    terra::project(crs)
  
  terra::writeRaster(
    country_forest_type,
    paste0(
      raster,
      "_srilanka",
      ".tiff"
    )
  )
}


## 3. LOAD VIRTUAL FILES ##
##-----------------------##

r_list <- list.files(
  path = getwd(),
  pattern = "_srilanka",
  full.names = T
)

forest_type_vrt <- terra::vrt(
  r_list,
  "srilanka_land_cover_vrt.vrt",
  overwrite =T
)

vals <- terra::values(
  forest_type_vrt,
  dataframe = T
)

names(vals)

names(vals)[1] <- "value"

unique(vals$value)

## 4. CROP FOREST TYPE RASTER ##
#------------------------------------##


crs_tmercator <- 
  "+proj=tmerc +lat_0=7.00047152777778 +lon_0=80.7717130833333 +k=0.9999238418 +x_0=500000 +y_0=500000 +ellps=evrst30 +towgs84=-0.293,766.95,87.713,-0.195704,-1.695068,-3.473016,-0.039338 +units=m +no_defs +type=crs"

country_forest_type <- terra::crop(
  forest_type_vrt,
  terra::vect(country_sf),
  snap = "in",
  mask = T
)|>
  terra::project(crs_tmercator)


terra::plot(country_forest_type)

## 5.FOREST TYPE RASTER TO IMAGE ##
#----------------------------------##

cols <- c(
  "#073b4c",
  "#ffcf6a",
  "#397d49",
  "#7cd8ff",
  "#8DD3C7"
)


from <- c(0:2, 4:5)
to <- t(col2rgb(
  cols
))


forest_terra <- na.omit(
  country_forest_type
)

forest_type_raster <- terra::subst(
  forest_terra,
  from,
  to,
  names = cols
)

terra::plotRGB(forest_type_raster)

img_file <- "Sri-Lanka-forest-type-image.png"

terra::writeRaster(
  forest_type_raster,
  img_file,
  overwrite = T,
  NAflag = 255
)

img <- png::readPNG(img_file)

```



